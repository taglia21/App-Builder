{% extends "base.html" %}
{% block title %}API Keys - LaunchForge{% endblock %}

{% block extra_css %}
<style>
    .api-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 32px;
    }
    .api-header h1 {
        font-size: 1.75rem;
        font-weight: 700;
        color: white;
    }
    .api-header p {
        font-size: 0.9375rem;
        color: #9ca3af;
        margin-top: 4px;
    }
    .api-key-card {
        background: var(--nexus-card);
        border: 1px solid var(--nexus-border);
        border-radius: 12px;
        padding: 20px 24px;
        margin-bottom: 16px;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }
    .api-key-info { flex: 1; }
    .api-key-name {
        font-size: 0.9375rem;
        font-weight: 600;
        color: white;
        margin-bottom: 4px;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    .api-key-badge {
        font-size: 0.6875rem;
        font-weight: 500;
        padding: 3px 8px;
        border-radius: 4px;
        background: rgba(34,197,94,0.15);
        color: #22c55e;
    }
    .api-key-value {
        font-family: "SF Mono", Monaco, monospace;
        font-size: 0.8125rem;
        color: #6b7280;
        margin-bottom: 8px;
    }
    .api-key-meta {
        font-size: 0.75rem;
        color: #6b7280;
    }
    .api-key-actions {
        display: flex;
        gap: 8px;
    }
    .btn-sm {
        padding: 8px 14px;
        font-size: 0.8125rem;
    }
    .security-notice {
        display: flex;
        gap: 16px;
        background: rgba(251,191,36,0.08);
        border: 1px solid rgba(251,191,36,0.2);
        border-radius: 12px;
        padding: 20px 24px;
        margin-bottom: 32px;
    }
    .security-notice svg {
        width: 20px; height: 20px;
        color: #fbbf24;
        flex-shrink: 0;
        margin-top: 2px;
    }
    .security-notice h3 {
        font-size: 0.9375rem;
        font-weight: 600;
        color: #fbbf24;
        margin-bottom: 4px;
    }
    .security-notice p {
        font-size: 0.875rem;
        color: #9ca3af;
        line-height: 1.5;
    }
    .create-key-section {
        background: var(--nexus-card);
        border: 1px solid var(--nexus-border);
        border-radius: 12px;
        padding: 24px;
        margin-top: 32px;
    }
    .create-key-section h3 {
        font-size: 1rem;
        font-weight: 600;
        color: white;
        margin-bottom: 16px;
    }
    .input-group {
        display: flex;
        gap: 12px;
    }
    .input-group input {
        flex: 1;
        background: rgba(0,0,0,0.3);
        border: 1px solid rgba(255,255,255,0.1);
        border-radius: 8px;
        padding: 12px 16px;
        font-size: 0.875rem;
        color: white;
        outline: none;
    }
    .input-group input:focus {
        border-color: #a855f7;
    }
    .input-group input::placeholder {
        color: #6b7280;
    }
</style>
{% endblock %}

{% block content %}
<div class="api-header">
    <div>
        <h1>API Keys</h1>
        <p>Manage your API keys for programmatic access</p>
    </div>
    <button class="btn btn-primary" onclick="document.getElementById('create-key-input').focus()"><i data-lucide="plus" style="width:16px;height:16px;"></i> Create New Key</button>
</div>

<!-- Toast notification -->
<div id="api-toast" style="display:none; position:fixed; top:24px; right:24px; z-index:9999; padding:16px 24px; border-radius:10px; font-size:0.875rem; font-weight:500; box-shadow:0 8px 24px rgba(0,0,0,0.4); transition: opacity 0.3s ease;">
    <span id="api-toast-msg"></span>
</div>

<!-- Key Created Modal -->
<div id="key-modal-overlay" style="display:none; position:fixed; inset:0; z-index:10000; background:rgba(0,0,0,0.7); backdrop-filter:blur(4px); align-items:center; justify-content:center;">
    <div style="background:var(--nexus-card); border:1px solid var(--nexus-border); border-radius:16px; padding:32px; max-width:560px; width:90%; box-shadow:0 24px 48px rgba(0,0,0,0.5);">
        <div style="display:flex; align-items:center; gap:12px; margin-bottom:20px;">
            <div style="width:40px; height:40px; border-radius:50%; background:rgba(34,197,94,0.15); display:flex; align-items:center; justify-content:center;">
                <svg style="width:20px; height:20px; color:#22c55e;" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
            </div>
            <div>
                <h3 style="font-size:1.125rem; font-weight:600; color:white; margin:0;">API Key Created</h3>
                <p style="font-size:0.8125rem; color:#9ca3af; margin:0;">Copy it now — you won't be able to see it again</p>
            </div>
        </div>
        <div style="background:var(--nexus-dark, #0a0a0b); border:1px solid var(--nexus-border); border-radius:8px; padding:14px 16px; margin-bottom:8px; position:relative;">
            <code id="modal-key-value" style="font-family:'SF Mono',Monaco,monospace; font-size:0.8125rem; color:#a5b4fc; word-break:break-all; display:block; padding-right:70px;"></code>
            <button id="modal-copy-btn" onclick="window.__apiKeys.copyModalKey()" style="position:absolute; right:8px; top:50%; transform:translateY(-50%); padding:6px 14px; background:#8b5cf6; border:none; border-radius:6px; color:white; font-size:0.75rem; font-weight:600; cursor:pointer;">Copy</button>
        </div>
        <p id="modal-copy-feedback" style="font-size:0.75rem; color:#6b7280; margin:0 0 16px 0; min-height:18px;"></p>
        <div style="padding:12px 16px; background:rgba(251,191,36,0.08); border:1px solid rgba(251,191,36,0.2); border-radius:8px; margin-bottom:24px;">
            <p style="font-size:0.8125rem; color:#fbbf24; margin:0;">⚠️ Store this key in a secure location. For security, we only show it once.</p>
        </div>
        <button onclick="window.__apiKeys.closeModal()" style="width:100%; padding:12px; background:#374151; border:1px solid #4b5563; border-radius:8px; color:white; font-weight:500; cursor:pointer; font-size:0.9375rem;">Done</button>
    </div>
</div>

<div class="security-notice">
    <i data-lucide="shield-alert"></i>
    <div>
        <h3>Keep your API keys secure</h3>
        <p>Never share your API keys in public repositories, client-side code, or publicly accessible areas. Treat them like passwords.</p>
    </div>
</div>

<div id="api-keys-list">
    <!-- Keys are rendered here by JS on load -->
</div>

<div class="create-key-section">
    <h3>Create New API Key</h3>
    <div class="input-group">
        <input type="text" id="create-key-input" placeholder="Enter a name for this key (e.g., Production, Staging)">
        <button class="btn btn-primary" id="create-key-btn">Create Key</button>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
(function() {
    var STORAGE_KEY = 'launchforge_api_keys';

    // --- helpers ---
    function generateKey() {
        var chars = 'abcdefghijklmnopqrstuvwxyz0123456789';
        var key = 'lf_key_sk_';
        for (var i = 0; i < 40; i++) key += chars.charAt(Math.floor(Math.random() * chars.length));
        return key;
    }

    function maskKey(key) {
        return key.substring(0, 10) + '************************' + key.slice(-4);
    }

    function formatDate(iso) {
        var d = new Date(iso);
        return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
    }

    function loadKeys() {
        var raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) {
            // Seed with default keys
            var defaults = [
                { id: 'key_1', name: 'Production Key', key: 'lf_prod_sk_a8d3f19e7c4b6052e1d9f3a8c7b2e4013f8a', created: '2026-02-01T12:00:00Z', lastUsed: '2 hours ago', active: true },
                { id: 'key_2', name: 'Development Key', key: 'lf_dev_sk_c4e2a1b8d7f6093e5a1c8d4b7f2e60a39b2c', created: '2026-02-05T12:00:00Z', lastUsed: '5 days ago', active: true }
            ];
            localStorage.setItem(STORAGE_KEY, JSON.stringify(defaults));
            return defaults;
        }
        return JSON.parse(raw);
    }

    function saveKeys(keys) {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(keys));
    }

    // --- toast ---
    function showToast(msg, type) {
        var el = document.getElementById('api-toast');
        var msgEl = document.getElementById('api-toast-msg');
        msgEl.textContent = msg;
        el.style.background = type === 'error' ? '#991b1b' : '#166534';
        el.style.color = '#fff';
        el.style.display = 'block';
        el.style.opacity = '1';
        clearTimeout(el._timer);
        el._timer = setTimeout(function() { el.style.opacity = '0'; setTimeout(function(){ el.style.display = 'none'; }, 300); }, 3500);
    }

    // --- render ---
    function renderKeys() {
        var keys = loadKeys();
        var container = document.getElementById('api-keys-list');
        if (!keys.length) {
            container.innerHTML = '<p style="color:#6b7280; font-size:0.875rem; padding:20px 0;">No API keys yet. Create one below.</p>';
            return;
        }
        var html = '';
        keys.forEach(function(k) {
            html += '<div class="api-key-card" data-key-id="' + k.id + '">' +
                '<div class="api-key-info">' +
                    '<div class="api-key-name">' + k.name + ' <span class="api-key-badge">' + (k.active ? 'Active' : 'Revoked') + '</span></div>' +
                    '<div class="api-key-value">' + maskKey(k.key) + '</div>' +
                    '<div class="api-key-meta">Created: ' + formatDate(k.created) + ' &bull; Last used: ' + (k.lastUsed || 'Never') + '</div>' +
                '</div>' +
                '<div class="api-key-actions">' +
                    (k.active
                        ? '<button class="btn btn-secondary btn-sm" onclick="window.__apiKeys.copyKey(\'' + k.id + '\')">Copy</button>' +
                          '<button class="btn btn-secondary btn-sm" onclick="window.__apiKeys.revokeKey(\'' + k.id + '\')">Revoke</button>'
                        : '<span style="color:#6b7280;font-size:0.8125rem;">Revoked</span>') +
                '</div>' +
            '</div>';
        });
        container.innerHTML = html;
    }

    // --- actions ---
    function createKey() {
        var input = document.getElementById('create-key-input');
        var name = input.value.trim();
        if (!name) { showToast('Please enter a name for the key.', 'error'); return; }
        var keys = loadKeys();
        var newKey = {
            id: 'key_' + Date.now(),
            name: name,
            key: generateKey(),
            created: new Date().toISOString(),
            lastUsed: 'Never',
            active: true
        };
        keys.unshift(newKey);
        saveKeys(keys);
        input.value = '';
        renderKeys();
        // Show the copy-once modal with the full key
        showKeyModal(newKey.key);
    }

    function showKeyModal(fullKey) {
        var overlay = document.getElementById('key-modal-overlay');
        document.getElementById('modal-key-value').textContent = fullKey;
        document.getElementById('modal-copy-feedback').textContent = '';
        document.getElementById('modal-copy-btn').textContent = 'Copy';
        document.getElementById('modal-copy-btn').style.background = '#8b5cf6';
        overlay.style.display = 'flex';
        overlay._fullKey = fullKey;
    }

    function closeModal() {
        document.getElementById('key-modal-overlay').style.display = 'none';
        showToast('API key created successfully!', 'success');
    }

    function copyModalKey() {
        var overlay = document.getElementById('key-modal-overlay');
        var feedback = document.getElementById('modal-copy-feedback');
        var btn = document.getElementById('modal-copy-btn');
        navigator.clipboard.writeText(overlay._fullKey).then(function() {
            feedback.textContent = '✓ Copied to clipboard!';
            feedback.style.color = '#22c55e';
            btn.textContent = 'Copied!';
            btn.style.background = '#16a34a';
            setTimeout(function() { btn.textContent = 'Copy'; btn.style.background = '#8b5cf6'; }, 2000);
        }).catch(function() {
            prompt('Copy this key:', overlay._fullKey);
        });
    }

    function revokeKey(id) {
        if (!confirm('Revoke this API key? This cannot be undone.')) return;
        var keys = loadKeys();
        keys = keys.map(function(k) { if (k.id === id) k.active = false; return k; });
        saveKeys(keys);
        renderKeys();
        showToast('API key revoked.', 'success');
    }

    function copyKey(id) {
        var keys = loadKeys();
        var found = keys.find(function(k) { return k.id === id; });
        if (!found) return;
        navigator.clipboard.writeText(found.key).then(function() {
            showToast('Key copied to clipboard!', 'success');
        }).catch(function() {
            prompt('Copy this key:', found.key);
        });
    }

    // expose for inline onclick
    window.__apiKeys = { revokeKey: revokeKey, copyKey: copyKey, copyModalKey: copyModalKey, closeModal: closeModal };

    // --- init ---
    document.getElementById('create-key-btn').addEventListener('click', createKey);
    document.getElementById('create-key-input').addEventListener('keydown', function(e) {
        if (e.key === 'Enter') createKey();
    });
    renderKeys();
})();
</script>
{% endblock %}
