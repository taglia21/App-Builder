<!-- GDPR Cookie Consent Banner -->
<div id="cookie-consent" 
     x-data="cookieConsent()" 
     x-show="showBanner" 
     x-cloak
     x-transition:enter="transition ease-out duration-300"
     x-transition:enter-start="opacity-0 translate-y-4"
     x-transition:enter-end="opacity-100 translate-y-0"
     x-transition:leave="transition ease-in duration-200"
     x-transition:leave-start="opacity-100 translate-y-0"
     x-transition:leave-end="opacity-0 translate-y-4"
     class="fixed bottom-0 inset-x-0 z-50 pb-4 px-4">
    
    <div class="max-w-4xl mx-auto bg-white rounded-xl shadow-2xl border border-gray-200 overflow-hidden">
        <!-- Main Banner -->
        <div class="p-6">
            <div class="flex items-start gap-4">
                <!-- Cookie Icon -->
                <div class="flex-shrink-0">
                    <div class="w-12 h-12 rounded-full bg-forge-100 flex items-center justify-center">
                        <svg class="w-6 h-6 text-forge-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4" />
                        </svg>
                    </div>
                </div>
                
                <!-- Content -->
                <div class="flex-1">
                    <h3 class="text-lg font-semibold text-gray-900">Cookie Preferences</h3>
                    <p class="mt-1 text-sm text-gray-600">
                        We use essential cookies to make our site work. With your consent, we may also use non-essential 
                        cookies to improve your experience and analyze site traffic. 
                        <a href="/privacy" class="text-forge-600 hover:text-forge-700 underline">Privacy Policy</a>
                    </p>
                    
                    <!-- Cookie Options (expanded view) -->
                    <div x-show="showDetails" x-collapse class="mt-4 space-y-3">
                        <!-- Essential Cookies -->
                        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                            <div class="flex-1">
                                <div class="flex items-center gap-2">
                                    <span class="font-medium text-gray-900">Essential Cookies</span>
                                    <span class="px-2 py-0.5 text-xs bg-gray-200 text-gray-600 rounded">Required</span>
                                </div>
                                <p class="text-sm text-gray-500 mt-0.5">
                                    Required for authentication, security, and core functionality.
                                </p>
                            </div>
                            <div class="flex-shrink-0 ml-4">
                                <div class="w-10 h-6 bg-forge-600 rounded-full flex items-center justify-end px-1 cursor-not-allowed opacity-75">
                                    <div class="w-4 h-4 bg-white rounded-full shadow"></div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Analytics Cookies -->
                        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                            <div class="flex-1">
                                <div class="flex items-center gap-2">
                                    <span class="font-medium text-gray-900">Analytics Cookies</span>
                                    <span class="px-2 py-0.5 text-xs bg-blue-100 text-blue-600 rounded">Optional</span>
                                </div>
                                <p class="text-sm text-gray-500 mt-0.5">
                                    Help us understand how visitors use our site (privacy-friendly Plausible analytics).
                                </p>
                            </div>
                            <div class="flex-shrink-0 ml-4">
                                <button @click="preferences.analytics = !preferences.analytics"
                                        :class="preferences.analytics ? 'bg-forge-600' : 'bg-gray-300'"
                                        class="w-10 h-6 rounded-full flex items-center transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-forge-500">
                                    <div :class="preferences.analytics ? 'translate-x-5' : 'translate-x-1'"
                                         class="w-4 h-4 bg-white rounded-full shadow transform transition-transform duration-200"></div>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Marketing Cookies -->
                        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                            <div class="flex-1">
                                <div class="flex items-center gap-2">
                                    <span class="font-medium text-gray-900">Marketing Cookies</span>
                                    <span class="px-2 py-0.5 text-xs bg-blue-100 text-blue-600 rounded">Optional</span>
                                </div>
                                <p class="text-sm text-gray-500 mt-0.5">
                                    Used for personalized content and relevant advertisements.
                                </p>
                            </div>
                            <div class="flex-shrink-0 ml-4">
                                <button @click="preferences.marketing = !preferences.marketing"
                                        :class="preferences.marketing ? 'bg-forge-600' : 'bg-gray-300'"
                                        class="w-10 h-6 rounded-full flex items-center transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-forge-500">
                                    <div :class="preferences.marketing ? 'translate-x-5' : 'translate-x-1'"
                                         class="w-4 h-4 bg-white rounded-full shadow transform transition-transform duration-200"></div>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Actions -->
            <div class="mt-6 flex flex-col sm:flex-row gap-3 sm:justify-end">
                <button @click="showDetails = !showDetails"
                        class="px-4 py-2 text-sm font-medium text-gray-700 hover:text-gray-900 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors">
                    <span x-text="showDetails ? 'Hide Details' : 'Customize'"></span>
                </button>
                <button @click="rejectAll()" onclick="rejectAllCookies()"
                        class="px-4 py-2 text-sm font-medium text-gray-700 hover:text-gray-900 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors">
                    Essential Only
                </button>
                <button @click="acceptAll()" onclick="acceptAllCookies()"
                        class="px-6 py-2 text-sm font-medium text-white bg-forge-600 hover:bg-forge-700 rounded-lg transition-colors shadow-sm">
                    Accept All
                </button>
                <button x-show="showDetails"
                        @click="savePreferences()"
                        class="px-6 py-2 text-sm font-medium text-white bg-green-600 hover:bg-green-700 rounded-lg transition-colors shadow-sm">
                    Save Preferences
                </button>
            </div>
        </div>
    </div>
</div>

<script>
function cookieConsent() {
    return {
        showBanner: false,
        showDetails: false,
        preferences: {
            essential: true, // Always true, cannot be disabled
            analytics: false,
            marketing: false
        },
        
        init() {
            // Check if consent was already given
            const consent = localStorage.getItem('cookie_consent');
            if (!consent) {
                // Show banner after a short delay for better UX
                setTimeout(() => {
                    this.showBanner = true;
                }, 1000);
            } else {
                // Load saved preferences
                try {
                    this.preferences = JSON.parse(consent);
                    this.applyPreferences();
                } catch (e) {
                    console.error('Error parsing cookie consent:', e);
                    this.showBanner = true;
                }
            }
        },
        
        acceptAll() {
            this.preferences = {
                essential: true,
                analytics: true,
                marketing: true
            };
            this.saveConsent();
        },
        
        rejectAll() {
            this.preferences = {
                essential: true,
                analytics: false,
                marketing: false
            };
            this.saveConsent();
        },
        
        savePreferences() {
            this.saveConsent();
        },
        
        saveConsent() {
            // Store in localStorage
            localStorage.setItem('cookie_consent', JSON.stringify(this.preferences));
            localStorage.setItem('cookie_consent_date', new Date().toISOString());
            
            // Apply preferences
            this.applyPreferences();
            
            // Hide banner
            this.showBanner = false;
            
            // Dispatch event for other scripts to listen
            window.dispatchEvent(new CustomEvent('cookieConsentUpdated', {
                detail: this.preferences
            }));
        },
        
        applyPreferences() {
            // Enable/disable analytics based on consent
            if (this.preferences.analytics) {
                this.enableAnalytics();
            } else {
                this.disableAnalytics();
            }
            
            // Enable/disable marketing scripts
            if (this.preferences.marketing) {
                this.enableMarketing();
            }
        },
        
        enableAnalytics() {
            // Enable Plausible if configured
            const plausibleDomain = document.querySelector('meta[name="plausible-domain"]')?.content;
            if (plausibleDomain && !document.querySelector('script[data-domain]')) {
                const script = document.createElement('script');
                script.defer = true;
                script.setAttribute('data-domain', plausibleDomain);
                script.src = 'https://plausible.io/js/script.js';
                document.head.appendChild(script);
            }
        },
        
        disableAnalytics() {
            // Plausible respects "Do Not Track" and doesn't need active disabling
            // Analytics script won't be loaded if not consented
        },
        
        enableMarketing() {
            // Placeholder for future marketing integrations
            // Add marketing script loading here when needed
        }
    };
}
</script>

<!-- Settings link for users to update preferences -->
<style>
    [x-cloak] { display: none !important; }
</style>
<script>
// Simple cookie consent handler - fallback for Alpine.js
function hideCookieBanner() {
    var banner = document.getElementById('cookie-consent');
    if (banner) banner.style.display = 'none';
}
function acceptAllCookies() {
    localStorage.setItem('cookie_consent', JSON.stringify({essential:true,analytics:true,marketing:true}));
    hideCookieBanner();
}
function rejectAllCookies() {
    localStorage.setItem('cookie_consent', JSON.stringify({essential:true,analytics:false,marketing:false}));
    hideCookieBanner();
}
</script>
